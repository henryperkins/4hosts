flowchart LR
  %% Updated architecture map (validated Sep 13, 2025)

  subgraph Orchestration
    RO[services/research_orchestrator.py]
    ERO[services/enhanced_research_orchestrator.py]
    DRS[services/deep_research_service.py]
    AG[services/answer_generator.py]
  end

  subgraph LLM_Core
    LLC[services/llm_client.py]
    ORC[services/openai_responses_client.py]
    BGL[services/background_llm.py]
  end

  subgraph Tools_Quality
    LQO[services/llm_query_optimizer.py]
    LCR[services/llm_critic.py]
    ACT[services/action_items.py]
    AGEN[services/agentic_process.py]
    TXT[services/text_compression.py]
  end

  subgraph Search_Evidence
    SAP[services/search_apis.py]
    PSD[services/paradigm_search.py]
    CRED[services/credibility.py]
    EVI[services/evidence_builder.py]
    BRV[services/brave_grounding.py]
    BMCP[services/brave_mcp_integration.py]
  end

  subgraph Progress_Cache_Metrics
    PRG[services/progress.py]
    WSS[services/websocket_service.py]
    CACH[services/cache.py]
    MTR[services/metrics.py]
    TRG[services/task_registry.py]
  end

  subgraph Contexting_Classification
    CENG[services/context_engineering.py]
    CLF[services/classification_engine.py]
    HFF[services/hf_zero_shot.py]
  end

  subgraph Data_Models
    PDM[models/paradigms.py]
    CTX[models/context_models.py]
    SYN[models/synthesis_models.py]
  end

  subgraph Utils
    TOK[utils/token_budget.py]
    TSAN[utils/text_sanitize.py]
    INJ[utils/injection_hygiene.py]
    ASU[utils/async_utils.py]
    CDOC[utils/custom_docs.py]
  end

  subgraph Auth_Security
    TM[services/token_manager.py]
    AUTH[services/auth_service.py]
    WSA[services/websocket_auth.py]
  end

  subgraph Integrations
    MCP[services/mcp_integration.py]
    EI[services/enhanced_integration.py]
    EXP_SVC[services/export_service.py]
    UM[services/user_management.py]
  end

  subgraph Storage
    RSR[services/research_store.py]
  end

  subgraph Experimentation
    EXP[services/experiments.py]
  end

  %% Orchestrator dependencies (direct)
  RO --> PSD
  RO --> SAP
  RO --> CRED
  RO --> DRS
  RO --> EVI
  RO --> PRG
  RO --> RSR
  RO --> CACH
  RO --> TXT
  RO --> PDM
  RO --> CTX
  RO -. optional .-> AG
  RO -. init .-> BMCP

  %% Deep Research Service (direct)
  DRS --> ORC
  DRS --> LLC
  DRS --> PRG
  DRS --> RSR
  DRS --> TOK
  DRS --> CTX

  %% LLM client core
  LLC --> ORC
  LLC -. init .-> BGL
  LLC --> MCP

  %% Background LLM
  BGL --> CACH
  BGL --> TRG
  BGL --> LLC

  %% Answer Generator
  AG --> LLC
  AG --> ACT
  AG --> TOK
  AG --> INJ
  AG --> PRG
  AG --> SYN
  AG --> PDM

  %% Query optimizer & critic
  LQO --> LLC
  LCR --> LLC
  LCR --> CRED

  %% Search & Evidence ancillary (corrected)
  EVI --> SAP
  CRED --> BRV
  CRED --> CACH
  BRV --> CACH

  %% Classification & Contexting (expanded)
  CLF --> PDM
  CLF -. may_use .-> LLC
  CENG --> LQO
  CENG --> CTX
  CENG --> PDM
  CENG --> LLC
  CENG --> MTR

  %% Responses client
  ORC -. "external_api" .-> EXT((OpenAI/Azure Responses))
  ORC --> LLC

  %% Progress/WebSocket/Auth
  PRG -. uses .-> WSS
  WSS --> WSA
  WSS --> AUTH
  WSA --> TM
  WSA --> AUTH
  AUTH --> TM

  %% Integrations
  BMCP --> MCP
  UM --> AUTH
  EXP_SVC --> RSR

  %% Experiment wiring
  DRS -. AB_prompts .-> EXP
  AG -. AB_prompts .-> EXP

  %% Legend
  %% solid arrow = direct import/use; dashed = optional/init/external

